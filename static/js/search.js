// static/js/search.js - Search functions
async function performSmartSearch() {
    const query = document.getElementById('search-query').value.trim();
    
    if (!query) {
        alert('Please enter a search query.');
        return;
    }
    
    // Show loading
    const container = document.getElementById('search-results');
    container.innerHTML = `
        <div class="loading">
            <i class="fas fa-brain"></i>
            <p>Thinking about your question...</p>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    
    try {
        // Use AI-powered search
        const response = await fetch('/api/search/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        
        const data = await response.json();
        displayAIResults(data);
        
    } catch (error) {
        console.error('Search error:', error);
        container.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error searching memories. Please try again.</p>
            </div>
        `;
    }
}

function displayAIResults(data) {
    const container = document.getElementById('search-results');
    const result = data.result;
    
    let html = `
        <div class="search-header">
            <h3>Search: "${data.query}"</h3>
            ${data.ai_available ? 
                '<span class="ai-badge"><i class="fas fa-brain"></i> AI-Powered Search</span>' : 
                '<span class="basic-badge"><i class="fas fa-search"></i> Basic Search</span>'
            }
        </div>
    `;
    
    // Display AI answer
    if (result.answer) {
        const confidencePercent = Math.round(result.confidence * 100);
        const confidenceLevel = confidencePercent > 80 ? 'high' : 
                               confidencePercent > 50 ? 'medium' : 'low';
        
        html += `
            <div class="ai-answer ${confidenceLevel}-confidence">
                <div class="answer-header">
                    <h4><i class="fas fa-comment-dots"></i> Answer</h4>
                    <div class="confidence-meter">
                        <div class="confidence-label">Confidence: ${confidencePercent}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                        </div>
                    </div>
                </div>
                <div class="answer-text">${result.answer}</div>
                ${result.ai_generated ? 
                    '<div class="ai-note"><i class="fas fa-robot"></i> Generated by AI based on family memories</div>' : 
                    '<div class="basic-note"><i class="fas fa-info-circle"></i> Based on keyword matching</div>'
                }
            </div>
        `;
    }
    
    // Display supporting memories
    if (result.memories && result.memories.length > 0) {
        html += `
            <div class="supporting-memories">
                <h4><i class="fas fa-book-open"></i> Supporting Memories</h4>
                <p class="supporting-description">These family memories contain relevant information:</p>
        `;
        
        result.memories.forEach((memory, index) => {
            const relevance = memory.relevance_score || 50;
            const relevancePercent = Math.min(100, Math.round(relevance));
            
            html += `
                <div class="memory-result">
                    <div class="memory-result-header">
                        <div class="memory-meta">
                            <span class="memory-category">${memory.category || 'memory'}</span>
                            <span class="memory-date">${memory.date || 'No date'} â€¢ ${memory.year || 'Unknown year'}</span>
                        </div>
                        <div class="memory-relevance">
                            <div class="relevance-bar">
                                <div class="relevance-fill" style="width: ${relevancePercent}%"></div>
                            </div>
                            <span class="relevance-percent">${relevancePercent}% relevant</span>
                        </div>
                    </div>
                    <div class="memory-text">"${escapeHtml(memory.text)}"</div>
                    ${memory.location_hint ? 
                        `<div class="location-hint"><i class="fas fa-map-marker-alt"></i> ${memory.location_hint}</div>` : 
                        ''
                    }
                    <div class="memory-actions">
                        <button onclick="viewMemory(${memory.id})" class="view-memory-btn">
                            <i class="fas fa-eye"></i> View Full Memory
                        </button>
                        <button onclick="addComment(${memory.id})" class="comment-btn">
                            <i class="fas fa-heart"></i> Add Love Note
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    } else if (!result.answer || result.answer.includes("couldn't find")) {
        html += `
            <div class="no-results">
                <i class="fas fa-search-minus"></i>
                <h4>No memories found</h4>
                <p>No family memories were found related to "${data.query}".</p>
                <div class="suggestions">
                    <p>Try:</p>
                    <ul>
                        <li>Using full names: "Jon Stiles" instead of just "Jon"</li>
                        <li>Asking specific questions: "Where was Jon Stiles born according to family stories?"</li>
                        <li>Checking if the information is in a different memory format</li>
                        <li>Adding this story to the family memories</li>
                    </ul>
                    <button onclick="showTab('capture')" class="btn-primary">
                        <i class="fas fa-plus-circle"></i> Add This Story
                    </button>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function highlightText(text, query) {
    const words = query.toLowerCase().split(' ');
    let highlighted = text;
    
    words.forEach(word => {
        if (word.length > 2) {
            const regex = new RegExp(`(${word})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark>$1</mark>');
        }
    });
    
    return highlighted;
}

function viewMemory(memoryId) {
    // Show timeline tab and highlight the memory
    showTab('timeline');
    // In a real implementation, you would scroll to and highlight the memory
    alert(`Memory ${memoryId} would be displayed in timeline view.`);
}

function addComment(memoryId) {
    showTab('comments');
    setTimeout(() => {
        // Set the memory ID in comment form if available
        const commentMemorySelect = document.getElementById('comment-memory');
        if (commentMemorySelect) {
            commentMemorySelect.value = memoryId;
        }
        alert(`Preparing to add a love note to memory ${memoryId}`);
    }, 100);
}